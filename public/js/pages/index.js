Ext.ns("utils");utils.zd=function(){return{INDEX_ALLOW_ROLL:"index.allow.roll",CHART_ALLOW_ROLL:"chart.allow.roll",DATA_ALLOW_ROLL:"data.allow.roll",HONOR_ALLOW_ROLL:"honor.allow.roll",INDEX_ROLL_TIME:"index.roll.time",CHART_ROLL_TIME:"chart.roll.time",DATA_ROLL_TIME:"data.roll.time",HONOR_ROLL_TIME:"honor.roll.time",RECIPE_ALLOW_JUMP:"recipe.allow.jump",RECIPE_JUMP_START_TIME:"recipe.jump.start.time",RECIPE_JUMP_END_TIME:"recipe.jump.end.time",recipeJumpSetup:null,stayInterval:60,getRecipeJumpSetup:function(){var b=this.getSetupValue(this.RECIPE_JUMP_START_TIME);if(!b){b="11:00"}var a=this.getSetupValue(this.RECIPE_JUMP_END_TIME);if(!a){a="11:30"}return{allowJump:this.getSetupValue(this.RECIPE_ALLOW_JUMP),startTime:b,endTime:a}},getRollSetup:function(){var e=this.getSetupValue(this.INDEX_ALLOW_ROLL);if(typeof(e)=="string"&&e.length==0){e=true}var b=this.getSetupValue(this.INDEX_ROLL_TIME);if(!b){b=10}var h=this.getSetupValue(this.CHART_ALLOW_ROLL);if(typeof(h)=="string"&&h.length==0){h=false}var c=this.getSetupValue(this.CHART_ROLL_TIME);if(!c){c=15}var g=this.getSetupValue(this.DATA_ALLOW_ROLL);if(typeof(g)=="string"&&g.length==0){g=false}var f=this.getSetupValue(this.DATA_ROLL_TIME);if(!f){f=10}var d=this.getSetupValue(this.HONOR_ALLOW_ROLL);if(typeof(d)=="string"&&d.length==0){d=false}var a=this.getSetupValue(this.HONOR_ROLL_TIME);if(!a){a=10}return{indexAllowRoll:e,indexRollTime:b,chartAllowRoll:h,chartRollTime:c,dataAllowRoll:g,dataRollTime:f,honorAllowRoll:d,honorRollTime:a}},numberPad:function(b,a){var c=""+b;while(c.length<a){c="0"+c}return c},recipeJump:function(a){if(!this.recipeJumpSetup){this.recipeJumpSetup=this.getRecipeJumpSetup()}if(!this.recipeJumpSetup.allowJump){return}var f=new Date();var c=this.numberPad(f.getHours(),2);var e=this.numberPad(f.getMinutes(),2);var b=this.numberPad(f.getSeconds(),2);var g=c+":"+e;if(g==this.recipeJumpSetup.startTime&&a!="recipe"){window.location.href="/zd/recipe.html";return true}if(g==this.recipeJumpSetup.endTime&&a!="index"){window.location.href="/zd/index.html";return true}return false},remainInRecipe:function(){if(!this.recipeJumpSetup){this.recipeJumpSetup=this.getRecipeJumpSetup()}if(!this.recipeJumpSetup.allowJump){return}var e=new Date();var b=this.numberPad(e.getHours(),2);var c=this.numberPad(e.getMinutes(),2);var a=this.numberPad(e.getSeconds(),2);var f=b+":"+c+a;return(f>=this.recipeJumpSetup.startTime+"00"&&f<=this.recipeJumpSetup.endTime+"00")},getSetupValue:function(a){var b="";Ext.Ajax.request({scope:this,url:"/zd/setups/"+a,method:"GET",async:false,success:function(c,d){var e=Ext.decode(c.responseText);b=e.value},failure:function(c,d){alert(c.responseText)}});if(b&&b=="1"){return true}if(b&&b=="0"){return false}return b},saveSetupValue:function(b,c){var a=c+"";if(c==true){a="1"}if(c==false){a="0"}Ext.Ajax.request({scope:this,url:"/zd/setups",async:false,method:"POST",jsonData:{code:b,value:a},failure:function(d,e){alert(d.responseText)}})},getCarTotalCount:function(){var a=0;Ext.Ajax.request({scope:this,url:"/zd/vehicles/count",method:"GET",async:false,success:function(b,c){var d=Ext.decode(b.responseText);a=d.count},failure:function(b,c){alert(b.responseText)}});return a},getEquipmentTotalCount:function(){var a=0;Ext.Ajax.request({scope:this,url:"/zd/equipments/count",method:"GET",async:false,success:function(b,c){var d=Ext.decode(b.responseText);a=d.count},failure:function(b,c){alert(b.responseText)}});return a},queryVehicleOutStatus:function(){Ext.Ajax.request({scope:this,url:"/zd/vehicle/statuschanges/lastest?outOnly=1",method:"GET",async:false,success:function(b,c){var e=Ext.decode(b.responseText);if(e.length==0){return}divo.publish("divo.header.stopRollAll");utils.zd.openLayer("tipsDiv");var d=60;var a={run:function(){if(d==0){window.location.reload();return}Ext.get("tipsContent").update(d);d-=1},scope:this,interval:1000};Ext.TaskMgr.start(a)}})},openLayer:function(g){var b=function(){var h;if(self.pageYOffset){h=self.pageYOffset}else{if(document.documentElement&&document.documentElement.scrollTop){h=document.documentElement.scrollTop}else{if(document.body){h=document.body.scrollTop}}}c=new Array("",h);return c};var f=function(){var l,h;if(window.innerHeight&&window.scrollMaxY){l=document.body.scrollWidth;h=window.innerHeight+window.scrollMaxY}else{if(document.body.scrollHeight>document.body.offsetHeight){sScroll=document.body.scrollWidth;h=document.body.scrollHeight}else{l=document.body.offsetWidth;h=document.body.offsetHeight}}var j,m;if(self.innerHeight){j=self.innerWidth;m=self.innerHeight}else{if(document.documentElement&&document.documentElement.clientHeight){j=document.documentElement.clientWidth;m=document.documentElement.clientHeight}else{if(document.body){j=document.body.clientWidth;m=document.body.clientHeight}}}var i,k;if(h<m){k=m}else{k=h}if(l<j){i=j}else{i=l}d=new Array(i,k,j,m);return d};var d=f();var c=b();var e=document.getElementById(g);if(!document.getElementById("bodybg")){var a=document.createElement("div");document.body.appendChild(a);a.setAttribute("id","bodybg");a.style.position="absolute";a.style.width=(d[0]+0+"px");a.style.height=(d[1]+35+"px");a.style.zIndex=2999;a.style.top=0;a.style.left=0;a.style.filter="alpha(opacity=50)";a.style.opacity=0.5;a.style.background="#000"}document.getElementById("bodybg").style.display="";e.style.display="";e.style.top=c[1]+(d[3]-e.offsetHeight)/2+"px";e.style.left=(d[0]-e.offsetWidth)/2+"px";e.style.zIndex=3000},closeLayer:function(a){document.getElementById(a).style.display="none";document.getElementById("bodybg").style.display="none";return false}}}();Ext.ns("divo.panel");Ext.ns("form.admin");Ext.ns("window.admin");Ext.ns("tree.admin");Ext.ns("grid.admin");Ext.ns("panel.zd");Ext.ns("form.zd");Ext.ns("window.zd");Ext.ns("grid.zd");Ext.ns("tree.zd");Ext.ns("window.board");Ext.ns("divo.index");divo.index.Main=function(){var a=false;var e=true;var g=10;var b=2;var d=2;var f=1;var c=Ext.get("status");return{init:function(){divo.subscribe("divo.header.stopRollAll",this.onStopRoll,this);var k=utils.zd.getRollSetup();e=k.indexAllowRoll;g=k.indexRollTime;if(!g){return}b=utils.zd.getCarTotalCount();if(b==0){return}f=1;if(location.href.indexOf("/zd/index.html?v=")>0){f=parseInt(location.href.split("/zd/index.html?v=")[1]);d=f+1}c.on("click",function(o,n){var m=[{text:"执勤",handler:this.onSelectStatus.createDelegate(this)},{text:"出动",icon:divo.iconUrl+"divo/busy.png",cls:"x-btn-text-icon",handler:this.onSelectStatus.createDelegate(this)},{text:"公务",handler:this.onSelectStatus.createDelegate(this)},{text:"修理",handler:this.onSelectStatus.createDelegate(this)},{text:"加油",handler:this.onSelectStatus.createDelegate(this)},{text:"保养",handler:this.onSelectStatus.createDelegate(this)},{text:"驻防",handler:this.onSelectStatus.createDelegate(this)}];var p=new Ext.menu.Menu({items:m});var l=c.getXY();l[0]=l[0]+25;l[1]=l[1]+40;p.showAt(l)},this);var j=0;var i=1;var h={run:function(){if(!a){if(j%3==0){utils.zd.queryVehicleOutStatus()}utils.zd.recipeJump("index");j+=1;if(e){if(j%g==0){if(d>b){divo.publish("divo.index.rollOver")}else{window.location.href="/zd/index.html?v="+d}}}else{if(j%utils.zd.stayInterval==0){divo.publish("divo.index.rollOver")}}}},scope:this,interval:1000};Ext.TaskMgr.start(h)},onStopRoll:function(){a=true},onSelectStatus:function(h,j){var i=function(){Ext.Ajax.request({scope:this,url:"/zd/vehicle/ordernumbers/"+f+"/status",async:true,method:"PUT",jsonData:{status:h.text},success:function(k,l){window.location.reload()},failure:function(k,l){this.alert(k.responseText)}})};i.defer(100,this)}}}();